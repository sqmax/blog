---
layout: post
title: "JavaWeb基础（三）-JSP总结"
date: 2018-02-12
author: SunQiang
categories: JavaWeb基础
tags: JavaWeb JSP
---
* content
{:toc}
JSP(Java Server Page)和Servlet是JavaEE规范的两个基本成员，它们是JavaWeb开发的基础知识。JSP和Servlet的本质是一样的,JSP最终必须编译成Servlet才能运行，或者说JSP只是生成Servlet的“草稿”文件。但是随着前后端技术的分离，而JSP会镶嵌有大量的Java代码，不利于前后端的分离，所以逐渐被弃用，被FreeMarker，Velocity，Tapestry等更纯粹的表现层技术所替代。但作为曾经最广泛使用的表现层技术，还是有必要学习一下的。




JSP比较简单，它的特点是在html页面中嵌入Java代码片段，或使用各种JSP标签，包括用户自定义标签，从而可以动态地提供页面内容。早期JSP页面的使用非常广泛，一个Web应用可以全部由JSP页面组成，只辅以少量的JavaBean即可。自JavaEE标准出现以后，人们逐渐认识到使用JSP充当过多的角色是不合适的。因此,JSP慢慢发展成单一的表现层技术，不再承担义务逻辑组件及持久层组件的责任。

## JSP的基本原理
JSP的本质是Servlet，当用户向指定Servlet发送请求时，Servlet利用输出流动态生成html页面，包括一些静态的html标签和所有在html页面中出现的内容。由于包括大量的html标签、大量的静态文本及格式，导致Servlet的开发效率低下。JSP的出现弥补了这种不足，JSP通过在标准的html页面中嵌入Java代码，`其静态的部分无需Java程序控制，只是那些需要从数据库读取或需要动态生成的页面内容，才使用Java脚本控制`。
从上介绍可以知道JSP页面的内容由如下两部分组成。

* 静态部分：标准的html标签、静态的页面内容，这些内容与静态的html页面相同。
* 动态部分：受Java程序控制的内容，这些内容由Java脚本动态生成。

下面新建一个web应用`jspPringciple`,并写一个简单的JSP页面`first.jsp`,然后请求该页面，看发生了哪些事。
`first.jsp` <br/>

```html
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>welcome</title>
</head>
<body>
	welcome to learn JSP,now it is 
	<%out.println(new java.util.Date()); %>
</body>
</html>
```
将web应用在Tomcat服务器上跑起来，然后浏览器地址栏输入：`http://localhost:8080/jspPrinciple/first.jsp`，可以在浏览器中看到该界面

![](http://wx3.sinaimg.cn/large/0072Njp2ly1fodzeqepd1j30ez05iglx.jpg)

从表面上看我们的web应用，只需要一个JSP界面就能够响应用户请求。事实是我们的Tomcat容器将JSP页面编译成Servlet，Servlet再负责响应用户请求。我用的eclipse开发的，其为上面first.jsp生成的Java类就在下面目录下：`eclipse-workspace/.metadata/.plugins/org.eclipse.wst.server.core/tmp0/work/Catalina/localhost/jspPrinciple/org/apache/jsp`,其中`eclipse-workspace`是我的eclipse工作空间，`jspPrinciple`是我的web应用名（如果你是手动直接将web应用部署在Tomcat中，那么生成的Java类就应该在Tomcat的`work/Catalina/localhost/jspPrinciple/org/apache/jsp`下）,名字就叫`first_jsp.java`。

![](http://wx1.sinaimg.cn/large/0072Njp2ly1fodzeuf5n9j30ks03e74w.jpg)
下面是`first_jsp.java`的源代码，这是一个特殊的Java类，是一个Servlet。

```java
/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: Apache Tomcat/8.5.27
 * Generated at: 2018-02-12 10:59:09 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */
package org.apache.jsp;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.jsp.*;
//继承自HttpJspBase类，该类其实是HttpServlet的子类
public final class first_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent,
                 org.apache.jasper.runtime.JspSourceImports {
	//这里省略一些代码.....

	  public void _jspInit() {
	  }

	  public void _jspDestroy() {
	  }
	//用于用户请求的方法
	  public void _jspService(final javax.servlet.http.HttpServletRequest request, final javax.servlet.http.HttpServletResponse response)
	      throws java.io.IOException, javax.servlet.ServletException {

	    final java.lang.String _jspx_method = request.getMethod();
	    if (!"GET".equals(_jspx_method) && !"POST".equals(_jspx_method) && !"HEAD".equals(_jspx_method) && !javax.servlet.DispatcherType.ERROR.equals(request.getDispatcherType())) {
	      response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, "JSPs only permit GET POST or HEAD");
	      return;
	    }

	    final javax.servlet.jsp.PageContext pageContext;
	    javax.servlet.http.HttpSession session = null;
	    final javax.servlet.ServletContext application;
	    final javax.servlet.ServletConfig config;
	    javax.servlet.jsp.JspWriter out = null;
	    final java.lang.Object page = this;
	    javax.servlet.jsp.JspWriter _jspx_out = null;
	    javax.servlet.jsp.PageContext _jspx_page_context = null;


	    try {
	      response.setContentType("text/html; charset=UTF-8");
	      pageContext = _jspxFactory.getPageContext(this, request, response,
	      			null, true, 8192, true);
	      _jspx_page_context = pageContext;
	      application = pageContext.getServletContext();
	      config = pageContext.getServletConfig();
	      session = pageContext.getSession();
	      out = pageContext.getOut();
	      _jspx_out = out;

	      out.write("\n");
	      out.write("<!DOCTYPE html PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\" \"http://www.w3.org/TR/html4/loose.dtd\">\n");
	      out.write("<html>\n");
	      out.write("<head>\n");
	      out.write("<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n");
	      out.write("<title>welcome</title>\n");
	      out.write("</head>\n");
	      out.write("<body>\n");
	      out.write("\twelcome to learn JSP,now it is \n");
	      out.write("\t");
	out.println(new java.util.Date()); 
	      out.write("\n");
	      out.write("</body>\n");
	      out.write("</html>");
	    } catch (java.lang.Throwable t) {
	      if (!(t instanceof javax.servlet.jsp.SkipPageException)){
		out = _jspx_out;
		if (out != null && out.getBufferSize() != 0)
		  try {
		    if (response.isCommitted()) {
		      out.flush();
		    } else {
		      out.clearBuffer();
		    }
		  } catch (java.io.IOException e) {}
		if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
		else throw new ServletException(t);
	      }
	    } finally {
	      _jspxFactory.releasePageContext(_jspx_page_context);
	    }
	  }
}

```
可以看到JSP页面中所有的内容都是由first_jsp.java文件的页面输出流来生成。下图显示了JSP页面的工作原理。

![](http://wx1.sinaimg.cn/large/0072Njp2ly1foejflkhu6j30ji0a4t9u.jpg)
根据上面分析及JSP页面工作原理图，可以得到如下4个结论。

* JSP文件必须在JSP服务器内进行。
* JSP文件必须生成Servlet才能执行。
* 每个JSP页面的第一个访问者速度很慢，因为必须等待JSP编译成Servlet。
* JSP页面的访问者无须安装客服端，甚至不需要可以运行Java的运行环境，因为JSP页面输送到客户端的是标准html页面。

## JSP用法的简要概括
附：[JSP API文档](http://tomcat.apache.org/tomcat-8.5-doc/jspapi/index.html)

### JSP四种基本语法


* JSP注释
```
<!--注释内容-->
```
* JSP声明
```
<%!声明部分!>
```
* JSP输出表达式
```
<%=表达式>
```
* JSP脚本
```
<%Java代码%>
```

### JSP 的3个编译指令

* page指令
```
<% @page
[language][extends][import]
[session][errorPage][pageEncoding]
[isErrorPage][contentType]
%>
```
* include指令
```
<%@include file="relativeURL"%>
```

### JSP 的7个动作指令
* jsp:forward：执行页面转向，将请求的处理转发到下一个页面。
* jsp:param：用于传递参数，必须与其它支持参数的标签一起使用。
* jsp:include:用于**动态**引入一个JSP页面。
* jsp:plugin:用于下载JavaBean或Applet到客户端执行。
* jsp:useBean:创建一个JavaBean的实例。
* jsp:setProperty:设置JavaBean实例的属性值。
* jsp:getProperty:输出JavaBean实例的属性值。

### JSP脚本中的9个内置对象

* application: `javax.servlet.ServletContext`的实例，该实例代表JSP所属的web应用本身，可用于JSP页面，或者在Servlet之间交换信息。
* config: `javax.servlet.ServletConfig`的实例，该实例代表该JSP的配置信息。
* exception: `javax.lang.Throwable`的实例，该实例代表其它页面中的异常和错误。只有当页面是错误处理页面，即编译指令page的isErrorPage属性为true时，该对象才可以使用。
* out: `javax.servlet.jsp.JspWriter`的实例，该实例代表JSP页面的输出流，用于输出内容，形成html页面。
* page:代表页面本身，通常没有太大用处。也就是Servlet中的this,其类型就是生成的Servlet类，能用page的地方就可用this。
* pageContext: `javax.servlet.jsp.PageContext`的实例，该对象代表该JSP页面上下文，使用该对象可以访问页面中的共享数据。
* request: `javax.servlet.http.HttpServletRequest`的实例，该对象封装了一次请求，客户端的请求参数都被封装在该对象里。
* response: `javax.servlet.http.HttpServletResponse`的实例，代表服务器对客户端的响应。通常很少使用该对象直接响应，而是使用out对象，除非需要生成非字符响应。
* session: `javax.servlet.httpSession`的实例，该对象代表一次会话。当客户端浏览器与站点建立连接时，会话开始，当客户端关闭浏览器时，会话结束。

### Cookie和session

* Cookie通常用于网站记录客户的某些信息，根据这些信息网站可以对客户提供更友好的服务。增加Cookie也是使用response内置对象完成的，response对象提供了如下方法：`void addCookie(Cookie cookie)`来增加Cookie。如上方法，在增加Cookie之前，必须先创建Cookie对象。<br/>
* session（HttpSession的实例）对象也是一个非常常用的对象，这个对象代表一次用户对话，一次用户对话的含义是客户端浏览器连接服务器开始，到客户端浏览器与服务器断开为止，这个过程就是一次会话。session通常用于跟踪用户的会话信息，如判断用户是否登录系统，或者在购物车应用中，用于跟踪用户购买的商品。session范围内的属性可以在多个页面的跳转之间共享。一旦关闭浏览器，session范围内的属性将全部丢失。

另外，Cookie的信息保存在客户端的硬盘上，session的信息保存在服务器的硬盘上。






